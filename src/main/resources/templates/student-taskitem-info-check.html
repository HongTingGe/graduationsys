<!DOCTYPE html>
<html class="x-admin-sm">
<head>
    <meta charset="UTF-8">
    <title>欢迎页面-X-admin2.2</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
    <link rel="stylesheet" href="/static/css/font.css">
    <link rel="stylesheet" href="/static/css/xadmin.css">
    <script type="text/javascript" src="/static/lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="/static/js/xadmin.js"></script>
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
<div class="layui-fluid">
    <div class="layui-row">
        <form class="layui-form" id="taskitemForm">
            <div class="layui-form-item">
                <label for="id" class="layui-form-label">
                    项目编号
                </label>
                <div class="layui-input-block">
                    <input type="text" id="id" name="id" lay-verify="required" autocomplete="off" class="layui-input" readonly>
                </div>
            </div>
            <div class="layui-form-item">
                <label for="sid" class="layui-form-label">
                    学号
                </label>
                <div class="layui-input-block">
                    <input type="text" id="sid" name="sid" autocomplete="off" class="layui-input" readonly>
                </div>
            </div>

            <div class="layui-form-item">
                <label for="sname" class="layui-form-label">
                    姓名
                </label>
                <div class="layui-input-block">
                    <input type="text" id="sname" name="sname" autocomplete="off" class="layui-input" readonly>
                </div>
            </div>

            <div class="layui-form-item">
                <label for="majorClazz" class="layui-form-label">
                    专业班级
                </label>
                <div class="layui-input-block">
                    <input type="text" id="majorClazz" name="majorClazz" autocomplete="off" class="layui-input" readonly>
                </div>
            </div>

            <div class="layui-form-item">
                <label for="name" class="layui-form-label">
                    课题名称
                </label>
                <div class="layui-input-block">
                    <input type="text" id="name" name="name" autocomplete="off" class="layui-input" readonly>
                </div>
            </div>


            <div class="layui-form-item">
                <label for="taskType" class="layui-form-label">
                    课题方向
                </label>
                <div class="layui-input-inline">
                    <select id="taskType" name="taskType" disabled>
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>



            <div class="layui-form-item layui-form-text" id="membersItem">
                <label for="members" class="layui-form-label">小组成员</label>
                <div class="layui-input-block">
                    <textarea id="members" name="members" class="layui-textarea" readonly></textarea>
                </div>
            </div>

            <div class="layui-form-item layui-form-text" id="membersForm">
                <label for="test" class="layui-form-label">小组成员</label>

                <div class="layui-card-body layui-table-body layui-table-main">
                    <table class="layui-table layui-form" id="test" lay-filter="test"></table>

                    <script type="text/html" id="toolbarDemo">
                        <div class="layui-btn-container">
                            <button class="layui-btn layui-btn-sm" type="button" onclick="a2()">添加成员</button>
                        </div>
                    </script>

                    <script type="text/html" id="barDemo">
                        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
                        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
                    </script>

                </div>


            </div>




            <div class="layui-form-item layui-form-text">
                <label for="details" class="layui-form-label">描述</label>
                <div class="layui-input-block">
                    <textarea id="details" name="details" class="layui-textarea" lay-verify="required" readonly></textarea>
                </div>
            </div>

            <div class="layui-form-item">
                <label for="createtime" class="layui-form-label">
                    申报时间
                </label>
                <div class="layui-input-block">
                    <input type="text" id="createtime" name="createtime" autocomplete="off" class="layui-input" readonly>
                </div>
            </div>


            <div class="layui-form-item" id="teacherItem">
                <label for="teacher" class="layui-form-label">
                    指导老师
                </label>
                <div class="layui-input-block">
                    <input type="text" id="teacher" name="teacher" autocomplete="off" class="layui-input" readonly>
                </div>
            </div>

            <div class="layui-form-item layui-form-text" id="msgItem">
                <label for="msg" class="layui-form-label">批注</label>
                <div class="layui-input-block">
                    <textarea id="msg" name="msg" class="layui-textarea" style="color:#FF5722" readonly ></textarea>
                </div>
            </div>


            <div class="layui-form-item" id="btn">
                <label class="layui-form-label"></label>
                <button class="layui-btn" lay-filter="declareAgain" lay-submit="">重新申报</button>
            </div>
        </form>
    </div>
</div>
<script>

    function timeFormat(time) {


        //date是传入的时间
        let d = new Date(time);

        let month = (d.getMonth() + 1) < 10 ? '0'+(d.getMonth() + 1) : (d.getMonth() + 1);
        let day = d.getDate()<10 ? '0'+d.getDate() : d.getDate();
        let hours = d.getHours()<10 ? '0'+d.getHours() : d.getHours();
        let min = d.getMinutes()<10 ? '0'+d.getMinutes() : d.getMinutes();
        let sec = d.getSeconds()<10 ? '0'+d.getSeconds() : d.getSeconds();

        let times=d.getFullYear() + '年' + month + '月' + day + '日 ' + hours + ':' + min + ':' + sec;



        return times;


    }



    layui.use(['form', 'layer','table'],
        function() {
            $ = layui.jquery;
            var form = layui.form,
                layer = layui.layer,
                table = layui.table;

            //课题方向
            $.ajax({
                url:'/task/list',
                type:'post',
                async: false,
                success:function (res) {
                    for(let i in res){
                        var optionStr = "";
                        optionStr = "<option value=" + res[i].name + " >" + res[i].name + "</option>";
                        $("#taskType").append(optionStr);
                    }
                    form.render('select');
                }
            })


            $.ajax({
                url:'/taskitem/infoId',
                type:'post',
                data:{
                    id:parent.stuRowData.id //当前行课题ID
                },
                success:function (res) {
                    $("#id").val(res.id);
                    $("#sid").val(res.sid);
                    $("#sname").val(res.sname);
                    $("#majorClazz").val(res.majorClazz);
                    $("#name").val(res.name);

                    $("#taskType").find("option:contains('"+res.type+"')").attr("selected",true);
                    form.render('select');
                    $("#createtime").val(timeFormat(res.createtime));


                    let members=JSON.parse(res.members);
                    for (let member of members){
                        member={
                            major:member.major,
                            sid:member.id,
                            name:member.name,
                            class:member.clazz
                        }
                        $("#members").append("专业:"+member.major+" "+" 班级:"+member.class+" "+" 学号:"+member.sid+" "+" 姓名:"+member.name)
                        addMember(member);
                    }

                    $("#details").val(res.details);
                    if (res.status==1) {

                        $.ajax({
                            url:'/pub/teacher/getName',
                            type:'post',
                            data:{
                                id:res.teacherid
                            },
                            success:function (name) {
                                $("#teacher").val(name);
                            }
                        });
                        //1成功

                        $("#msg").val(res.msg);
                        $("#btn").hide();
                        $("#membersForm").hide();
                    }else if (res.status==2){
                        //2失败
                        $("#name").removeAttr("readonly");

                        $("#taskType").removeAttr("disabled");
                        form.render('select');
                        $("#details").removeAttr("readonly");
                        $("#teacherItem").hide();
                        $("#msg").val(res.msg);
                        $("#membersItem").hide();
                    }else {
                        //0待审核
                        $("#teacherItem").hide();
                        $("#msgItem").hide();
                        $("#btn").hide();
                        $("#membersForm").hide();
                    }
                }
            });

            table.render({
                elem: '#test'
                ,toolbar: '#toolbarDemo'
                ,title: '用户数据表'
                ,cols: [[
                    {type: 'checkbox', fixed: 'left'}
                    ,{field:'college', title:'学院'}
                    ,{field:'major', title:'专业'}
                    ,{field:'class', title:'班级'}
                    ,{field:'sid', title:'学号'}
                    ,{field:'username', title:'姓名'}
                    ,{fixed: 'right', title:'操作', toolbar: '#barDemo', width:150}
                ]]
                ,data: [{
                    "college": ""
                    ,"major": ""
                    ,"class": ""
                    ,"sid": ""
                    ,"username": ""
                }]
            });

            $("tbody").remove();


            //监听行工具事件
            table.on('tool(test)', function(obj){
                myobj = obj;
                rowData = obj.data;

                if(obj.event === 'del'){
                    layer.confirm('真的删除行么', function(index){
                        obj.del();
                        layer.close(index);
                    });
                } else if(obj.event === 'edit'){



                    layer.open({
                        type: 2,
                        title: '编辑成员',
                        shade: [0],
                        area: ['750px', '500px'],
                        anim: 2,
                        content: ['/member-edit', 'yes']//iframe的url，no代表不显示滚动条
                    });

                }
            });



            //监听提交
            form.on('submit(declareAgain)',

                function(data) {

                    let members=new Array();
                    let objs=layui.table.cache["test"];

                    for (let i in objs) {
                        if (objs[i].sid==''){
                            break;
                        }
                        let obj={
                            id: objs[i].sid,
                            name: objs[i].username,
                            major: objs[i].major,
                            clazz: objs[i].class
                        };
                        members.push(obj);
                    }

                    layer.alert("确定重新申报么", {
                            icon: 6
                        },
                        function() {

                            $.ajax({
                                url:'/student/taskitem/update',
                                type:'post',
                                data:{
                                    id : $("#id").val(),
                                    name:$("#name").val(),
                                    type:$("#taskType").val(),
                                    members:JSON.stringify(members),
                                    details:$("#details").val(),
                                },
                                success:function () {
                                    // 获得frame索引
                                    var index = parent.layer.getFrameIndex(window.name);
                                    //关闭当前frame
                                    parent.layer.close(index);
                                    window.parent.location.reload();

                                }
                            })

                        });
                    return false;

                });


        });



</script>
<script>
    var memberTmp = new Array();//保存添加成员数组

    function updateMember(res) {//更新编辑成员信息
        myobj.update({
            college:res.college,
            major:res.major,
            class:res.class,
            sid:res.sid,
            username: res.name
        });
    }

    function addMember(res) {//添加成员
        let memberInfo={
            college : res.college,
            major : res.major,
            class : res.class,
            sid : res.sid,
            username : res.name
        };
        memberTmp.push(memberInfo);
        layui.table.reload("test",{
            data:memberTmp  // 将新数据重新载入表格
        });
    }

    function a2() {
        if (memberTmp.length>2){
            alert("小组成员最多3人");
            return;
        }
        layer.open({
            type: 2,
            title: '添加成员',
            area: ['750px', '400px'],
            anim: 2,
            content: ['/member-save', 'yes'] //iframe的url，no代表不显示滚动条

        });
    }
</script>

</body>

</html>
